---
title: "Food customs (Cambodia): Analysis Driver"
format:
  html:
    toc: true
    code-fold: false
execute:
  echo: false
  warning: false
  message: false
  cache: FALSE
editor: source
---


```{r setup}
# 00 | setup ----
set.seed(2025)
options(
  mc.cores = max(1, parallel::detectCores() - 1),
  brms.backend = "cmdstanr"
)
here::i_am("analysis/01_driver_analysis.qmd")

# package load
pkgs <- c("tidyverse","readxl","janitor","GGally","sf",
          "brms","cmdstanr","broom.mixed","gtsummary","here","gt", "webshot2")
invisible(lapply(pkgs, require, character.only = TRUE))

# project paths
PATH_XLSX <- here::here("analysis","data","raw","rawfish_eat_Cambodia_2020_2022.xlsx")
PATH_SHP  <- here::here("analysis","data","raw","KHM_adm","KHM_adm4.shp")
OUT_DIR   <- here::here("analysis","outputs")
dir.create(OUT_DIR, showWarnings = FALSE, recursive = TRUE)

# optional: QUICK mode for fast test
# For final manuscript, turn it FALSE.
QUICK <- FALSE
```

```{r data, include=FALSE}
## Analysis
# load data
source(here::here("analysis","R","10_load_clean.R"))

dat_list <- load_and_clean(PATH_XLSX, PATH_SHP, out_dir = OUT_DIR, dry_run = FALSE)
dat <- dat_list$dat
stopifnot(is.data.frame(dat), nrow(dat) > 0)
```

```{r pca, include=FALSE}
# pca to decompose food-neophobia scales
source(here::here("analysis","R","20_pca_scores.R"))
pca_out  <- make_pca(dat, out_dir = OUT_DIR, quick = QUICK, dry_run = FALSE)
long     <- pca_out$long
```

```{r participation, include = FALSE}
# 30_model_participation.R を読み込む
source(here::here("analysis","R","30_model_participation.R"))
# 参加モデルの実行（本番）
fit_part <- fit_participation(
  long        = long,
  out_dir     = OUT_DIR,
  quick       = QUICK,          # テスト時だけ TRUE
  dry_run     = FALSE,
  use_monotonic     = TRUE,     # q022_ord があれば mo() を使う
  use_q022_cat5     = FALSE,    # 使うなら TRUE
  interact_q022_dish= FALSE,    # 交互作用は使わない方針
  random_slope      = FALSE     # (1|district)；傾きは欲張らない
)

print(fit_part)
```

```{r frequency, include = FALSE}
# 40_model_frequency.R を読み込み

source(here::here("analysis","R","40_model_frequency.R"))

# dat_raw の用意：dat_scored があれば優先、無ければ dat を使用

dat_raw <- if (exists("dat_scored")) dat_scored else dat

# まず dry-run で構造チェック（任意）

freq_check <- fit_frequency_season_occ(
long = long, dat_raw = dat_raw, out_dir = OUT_DIR,
quick = TRUE, dry_run = TRUE
)
print(freq_check)

# 本番フィット（0許容NB・月は入れない・郡REは切片のみ）

fit_freq <- fit_frequency_season_occ(
long = long, dat_raw = dat_raw, out_dir = OUT_DIR,
quick = QUICK, dry_run = FALSE,
random_slope = FALSE,
trunc_zero   = FALSE,
include_month = FALSE
)

# 要約（ログ確認用）

print(summary(fit_freq), digits = 2)

```


```{r wtp, include=FALSE}
# 50_model_wtp.R を読み込み（変更なし）
source(here::here("analysis","R","50_model_wtp.R"))

# --- month（数値/英語月名/表記ゆれ）→ 1..12 に安全変換して season を作る補助 ---
safe_month_to_num <- function(x) {
  s <- tolower(trimws(as.character(x)))
  # 既に数値なら採用
  num <- suppressWarnings(as.numeric(s))
  out <- ifelse(!is.na(num) & num >= 1 & num <= 12, as.integer(num), NA_integer_)
  # 英語の省略/フル（jan..dec / january..december）
  out[is.na(out)] <- {
    idx_abb  <- match(s[is.na(out)], tolower(month.abb))
    idx_name <- match(s[is.na(out)], tolower(month.name))
    v <- ifelse(!is.na(idx_abb), idx_abb, idx_name)
    # 一致しなければ parse_number（"2022-09" 等から 9 を拾う）
    v2 <- suppressWarnings(readr::parse_number(s[is.na(out)]))
    v <- ifelse(!is.na(v), v, v2)
    as.integer(v)
  }
  # 範囲外は NA
  out[!(out %in% 1:12)] <- NA_integer_
  out
}

# --- WTP: q117–q327 を long にし、dish_type / youandme と season を付与 ---
wtp_from_q <- function(d){
  stopifnot(is.data.frame(d))
  d <- d %>% dplyr::mutate(id = as.character(id))

  # month→season（wet=5–10, dry=11–4）※monthが文字/因子でも安全
  if (!"season" %in% names(d) && "month" %in% names(d)) {
    m_num <- safe_month_to_num(d$month)
    d <- d %>%
      dplyr::mutate(
        season = factor(dplyr::case_when(
          is.na(m_num)    ~ NA_character_,
          m_num %in% 5:10 ~ "wet",
          TRUE            ~ "dry"
        ), levels = c("wet","dry"))
      )
  }

  # 価格キーとマップ
  price_keys <- intersect(c("q117","q118","q217","q218","q317","q327"), names(d))
  if (length(price_keys) == 0L) stop("q117,q118,q217,q218,q317,q327 が見つかりません。")

  key_map <- tibble::tribble(
    ~key,   ~dish_type,     ~youandme,
    "q117", "chopped_fish", "self",
    "q118", "chopped_fish", "others",
    "q217", "sliced_fish",  "self",
    "q218", "sliced_fish",  "others",
    "q317", "pufferfish",   "self",
    "q327", "pufferfish",   "others"
  )

  num_clean_999 <- function(x){
    v <- suppressWarnings(as.numeric(x))
    v[v == 999] <- NA_real_
    v
  }

  carry <- intersect(c("id","district","gender","month","season","year","commune","village","wave"), names(d))

  d %>%
    dplyr::select(dplyr::any_of(c(carry, price_keys))) %>%
    tidyr::pivot_longer(dplyr::all_of(price_keys), names_to = "key", values_to = "price") %>%
    dplyr::left_join(key_map, by = "key") %>%
    dplyr::mutate(
      price    = num_clean_999(price),
      dish_type= factor(dish_type, levels = c("chopped_fish","sliced_fish","pufferfish")),
      youandme = factor(youandme,  levels = c("self","others"))
    ) %>%
    dplyr::filter(!is.na(price), price > 0, !is.na(dish_type), !is.na(youandme))
}

# dat から WTPデータ生成
wtp_dat <- wtp_from_q(dat) %>%
  dplyr::select(dplyr::any_of(c(
    "price","district","gender","dish_type","youandme","season","month","id","wave"
  )))

# --- 診断：season が実際に入っているか（基礎集計）
wtp_dat %>% dplyr::count(season, sort = TRUE) %>% print(n = 10)
wtp_dat %>% dplyr::count(dish_type, youandme, season, sort = TRUE) %>% print(n = 30)

# dry-run（50_model_wtp.R は無改変／quick=FALSE）
wtp_check <- fit_wtp_model(
  wtp_dat, out_dir = OUT_DIR,
  family = "lognormal",
  quick = FALSE, dry_run = TRUE,
  backend = "cmdstanr"
)
print(wtp_check)

# 本番フィット（quick=FALSE）
fit_wtp <- fit_wtp_model(
  wtp_dat, out_dir = OUT_DIR,
  family = "lognormal",
  random_intercept = TRUE,
  quick = FALSE,
  dry_run = FALSE,
  backend = "cmdstanr",
  cores = getOption("mc.cores", 4), threads_per_chain = 4
)

print(summary(fit_wtp), digits = 2)
``` 

```{r sessioninfo, include=FALSE}
# print session information
sessionInfo()
```

